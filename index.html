<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Expense Tracker - Track Your Expenses in Rupees</title>
    <meta name="description" content="Track your daily expenses in Indian Rupees with Google Drive integration">
    
    <!-- Comprehensive CSP for Google OAuth - Very permissive to handle dynamic script loading -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; img-src * data: blob: 'unsafe-inline'; style-src 'self' 'unsafe-inline' *; font-src * data: blob:; script-src 'self' 'unsafe-inline' 'unsafe-eval' * blob: data:; frame-src * blob: data:; connect-src * blob: data:; object-src 'none'; media-src * data: blob:; worker-src 'self' blob: data:; child-src * blob: data:; form-action 'self' *; base-uri 'self'; frame-ancestors 'none';">
    
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script async defer src="https://apis.google.com/js/api.js" onload="document.dispatchEvent(new Event('gapi_loaded'))"></script>
    <script src="app.js"></script>
    <script>
        // Enhanced Google API loading with better error handling
        let domReady = false;
        let gapiReady = false;
        
        function checkReadyAndInit() {
            if (domReady && gapiReady && window.initClient) {
                console.log('Initializing Google API client...');
                window.initClient();
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            domReady = true;
            console.log('DOM ready');
            checkReadyAndInit();
        });
        
        document.addEventListener('gapi_loaded', () => {
            gapiReady = true;
            console.log('Google API loaded');
            checkReadyAndInit();
        });
        
        // Enhanced fallback with multiple retry attempts
        window.addEventListener('load', () => {
            let retryCount = 0;
            const maxRetries = 5;
            
            function retryGapiInit() {
                if (window.gapi && !gapiReady && retryCount < maxRetries) {
                    console.log(`Retry attempt ${retryCount + 1} for Google API initialization`);
                    gapiReady = true;
                    checkReadyAndInit();
                } else if (retryCount < maxRetries) {
                    retryCount++;
                    setTimeout(retryGapiInit, 1000);
                } else {
                    console.warn('Google API failed to load after multiple attempts');
                }
            }
            
            setTimeout(retryGapiInit, 1000);
        });
    </script>
</head>
<body>
    <div class="app-container">
        <!-- Google Drive Setup Instructions Banner -->
        <div id="setup-banner" class="auth-banner" style="background: var(--color-bg-6);">
            <div class="auth-content" style="flex-direction: column; gap: var(--space-12);">
                <div class="auth-message">
                    <span class="auth-icon">‚ö†Ô∏è</span>
                    <strong>Setup Required:</strong> Add your Vercel domain to Google Cloud Console
                </div>
                <div style="font-size: var(--font-size-xs); text-align: center; max-width: 100%;">
                    <p style="margin: 0 0 var(--space-8) 0;">Go to <strong>Google Cloud Console</strong> ‚Üí <strong>APIs & Services</strong> ‚Üí <strong>Credentials</strong></p>
                    <p style="margin: 0 0 var(--space-8) 0;">Click your OAuth 2.0 Client ID and add your domain to <strong>Authorized JavaScript origins</strong></p>
                    <p style="margin: 0; color: var(--color-primary); font-weight: 500;">Example: https://your-app-name.vercel.app</p>
                </div>
                <button class="btn btn--secondary btn--sm" onclick="document.getElementById('setup-banner').style.display='none'">Dismiss</button>
            </div>
        </div>

        <!-- Google Drive Authentication Banner -->
        <div id="auth-banner" class="auth-banner">
            <div class="auth-content">
                <div class="auth-message">
                    <span class="auth-icon">‚òÅÔ∏è</span>
                    <span>Connect to Google Drive for cloud sync</span>
                </div>
                <button class="btn btn--primary btn--sm" onclick="app.connectGoogleDrive()">Connect Drive</button>
            </div>
        </div>

        <!-- Sync Status Bar -->
        <div id="sync-status" class="sync-status hidden">
            <div class="sync-content">
                <span class="sync-indicator">
                    <span class="sync-dot" id="sync-dot"></span>
                    <span id="sync-text">Local Storage</span>
                </span>
                <button class="sync-button" onclick="app.showSyncSettings()" title="Sync Settings">‚öôÔ∏è</button>
            </div>
        </div>

        <!-- Mobile-First Bottom Navigation -->
        <nav class="bottom-nav">
            <button class="nav-item active" data-view="dashboard">
                <span class="nav-icon">üè†</span>
                <span class="nav-label">Dashboard</span>
            </button>
            <button class="nav-item" data-view="add-expense">
                <span class="nav-icon">‚ûï</span>
                <span class="nav-label">Add</span>
            </button>
            <button class="nav-item" data-view="payment-methods">
                <span class="nav-icon">üí≥</span>
                <span class="nav-label">Methods</span>
            </button>
            <button class="nav-item" data-view="reminders">
                <span class="nav-icon">üîî</span>
                <span class="nav-label">Reminders</span>
            </button>
            <button class="nav-item" data-view="analytics">
                <span class="nav-icon">üìä</span>
                <span class="nav-label">Analytics</span>
            </button>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Dashboard View -->
            <div id="dashboard" class="view active">
                <div class="view-header">
                    <h1>Dashboard</h1>
                    <button class="btn btn--primary" onclick="showView('add-expense')">
                        ‚ûï Add Expense
                    </button>
                </div>
                
                <div class="dashboard-grid">
                    <!-- Monthly Summary Card -->
                    <div class="card">
                        <div class="card__body">
                            <h3>This Month</h3>
                            <div class="metric">
                                <span class="metric__value" id="monthly-total">‚Çπ0.00</span>
                                <span class="metric__label">Total Expenses</span>
                            </div>
                        </div>
                    </div>

                    <!-- Payment Methods Breakdown -->
                    <div class="card">
                        <div class="card__body">
                            <h3>Payment Methods</h3>
                            <div id="payment-breakdown" class="payment-breakdown">
                                <div class="empty-state">
                                    <h4>No expenses yet</h4>
                                    <p>Start by adding your first payment method</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Upcoming Reminders -->
                    <div class="card">
                        <div class="card__body">
                            <h3>Upcoming Payments</h3>
                            <div id="upcoming-reminders" class="reminders-list">
                                <div class="empty-state">
                                    <h4>No reminders set</h4>
                                    <p>Set up bill reminders to never miss a payment</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Transactions -->
                    <div class="card recent-transactions">
                        <div class="card__body">
                            <h3>Recent Transactions</h3>
                            <div id="recent-transactions" class="transactions-list">
                                <div class="empty-state">
                                    <h4>No transactions yet</h4>
                                    <p>Your expenses will appear here as you add them</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Add Expense View -->
            <div id="add-expense" class="view">
                <div class="view-header">
                    <h1>Add Expense</h1>
                </div>
                
                <div class="form-container">
                    <form id="expense-form" class="expense-form">
                        <div class="form-group">
                            <label class="form-label" for="expense-date">Date</label>
                            <input type="date" id="expense-date" class="form-control" required>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="expense-amount">Amount (‚Çπ)</label>
                            <input type="number" id="expense-amount" class="form-control" step="0.01" min="0" required placeholder="0.00">
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="expense-description">Description</label>
                            <input type="text" id="expense-description" class="form-control" required placeholder="e.g., Grocery shopping">
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="expense-category">Category</label>
                            <select id="expense-category" class="form-control" required>
                                <option value="">Select Category</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="expense-payment-method">Payment Method</label>
                            <select id="expense-payment-method" class="form-control" required>
                                <option value="">Select Payment Method</option>
                            </select>
                            <small class="form-help">Need to add a payment method? <a href="#" onclick="showView('payment-methods')">Add one here</a></small>
                        </div>

                        <div class="form-actions">
                            <button type="submit" class="btn btn--primary btn--full-width">Add Expense</button>
                            <button type="button" class="btn btn--secondary btn--full-width" onclick="resetExpenseForm()">Clear Form</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Payment Methods View -->
            <div id="payment-methods" class="view">
                <div class="view-header">
                    <h1>Payment Methods</h1>
                    <button class="btn btn--primary" onclick="showAddPaymentMethodForm()">
                        ‚ûï Add Method
                    </button>
                </div>
                
                <div id="payment-methods-list" class="payment-methods-grid">
                    <div class="empty-state">
                        <h3>No payment methods</h3>
                        <p>Add your bank accounts, cards, and UPI methods to get started</p>
                        <button class="btn btn--primary" onclick="showAddPaymentMethodForm()">Add First Payment Method</button>
                    </div>
                </div>

                <!-- Add Payment Method Modal -->
                <div id="payment-method-modal" class="modal hidden">
                    <div class="modal__overlay" onclick="hidePaymentMethodForm()"></div>
                    <div class="modal__content">
                        <h3>Add Payment Method</h3>
                        <form id="payment-method-form">
                            <div class="form-group">
                                <label class="form-label" for="pm-name">Name</label>
                                <input type="text" id="pm-name" class="form-control" placeholder="e.g., HDFC Visa, SBI Savings" required>
                            </div>

                            <div class="form-group">
                                <label class="form-label" for="pm-type">Type</label>
                                <select id="pm-type" class="form-control" required>
                                    <option value="">Select Type</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label class="form-label" for="pm-last-four">Last 4 Digits (Optional)</label>
                                <input type="text" id="pm-last-four" class="form-control" maxlength="4" placeholder="1234">
                            </div>

                            <div class="form-group">
                                <label class="form-label" for="pm-color">Color</label>
                                <div class="color-picker">
                                    <input type="color" id="pm-color" class="form-control" value="#1FB8CD">
                                </div>
                            </div>

                            <div class="form-actions">
                                <button type="submit" class="btn btn--primary btn--full-width">Add Payment Method</button>
                                <button type="button" class="btn btn--secondary btn--full-width" onclick="hidePaymentMethodForm()">Cancel</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Reminders View -->
            <div id="reminders" class="view">
                <div class="view-header">
                    <h1>Bill Reminders</h1>
                    <button class="btn btn--primary" onclick="showAddReminderForm()">
                        ‚ûï Add Reminder
                    </button>
                </div>
                
                <div id="reminders-list" class="reminders-grid">
                    <div class="empty-state">
                        <h3>No reminders</h3>
                        <p>Set up bill reminders so you never miss a payment</p>
                        <button class="btn btn--primary" onclick="showAddReminderForm()">Add First Reminder</button>
                    </div>
                </div>

                <!-- Add Reminder Modal -->
                <div id="reminder-modal" class="modal hidden">
                    <div class="modal__overlay" onclick="hideReminderForm()"></div>
                    <div class="modal__content">
                        <h3>Add Bill Reminder</h3>
                        <form id="reminder-form">
                            <div class="form-group">
                                <label class="form-label" for="reminder-name">Reminder Name</label>
                                <input type="text" id="reminder-name" class="form-control" placeholder="e.g., House Rent, Credit Card Bill" required>
                            </div>

                            <div class="form-group">
                                <label class="form-label" for="reminder-amount">Amount (Optional)</label>
                                <input type="number" id="reminder-amount" class="form-control" step="0.01" min="0" placeholder="0.00">
                            </div>

                            <div class="form-group">
                                <label class="form-label" for="reminder-due-date">Due Date</label>
                                <input type="date" id="reminder-due-date" class="form-control" required>
                            </div>

                            <div class="form-group">
                                <label class="form-label" for="reminder-recurrence">Recurrence</label>
                                <select id="reminder-recurrence" class="form-control" required>
                                    <option value="">Select Recurrence</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label class="form-label" for="reminder-payment-method">Payment Method</label>
                                <select id="reminder-payment-method" class="form-control" required>
                                    <option value="">Select Payment Method</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label class="form-label" for="reminder-days">Remind me (days before)</label>
                                <input type="number" id="reminder-days" class="form-control" min="1" max="30" value="3" required>
                            </div>

                            <div class="form-actions">
                                <button type="submit" class="btn btn--primary btn--full-width">Add Reminder</button>
                                <button type="button" class="btn btn--secondary btn--full-width" onclick="hideReminderForm()">Cancel</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Analytics View -->
            <div id="analytics" class="view">
                <div class="view-header">
                    <h1>Analytics</h1>
                    <div class="month-selector">
                        <button class="btn btn--outline" onclick="changeMonth(-1)">‚Üê Prev</button>
                        <span id="current-month-display"></span>
                        <button class="btn btn--outline" onclick="changeMonth(1)">Next ‚Üí</button>
                    </div>
                </div>
                
                <div id="analytics-content" class="analytics-grid">
                    <div class="card">
                        <div class="card__body">
                            <h3>Spending by Category</h3>
                            <div class="chart-container" style="position: relative; height: 300px;">
                                <canvas id="category-chart"></canvas>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card__body">
                            <h3>Payment Method Usage</h3>
                            <div class="chart-container" style="position: relative; height: 300px;">
                                <canvas id="payment-method-chart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings View -->
            <div id="settings" class="view">
                <div class="view-header">
                    <h1>Settings</h1>
                </div>
                
                <div class="settings-grid">
                    <div class="card">
                        <div class="card__body">
                            <h3>Google Drive Integration</h3>
                            <div id="google-connection-status" class="connection-status">
                                <div class="status-indicator">
                                    <span class="status-dot offline"></span>
                                    <span>Not Connected</span>
                                </div>
                                <p>Connect to Google Drive to sync your data across devices.</p>
                                <div class="settings-actions">
                                    <button class="btn btn--primary" onclick="app.connectGoogleDrive()">Connect to Google Drive</button>
                                    <button class="btn btn--outline" onclick="app.exportData()">Export Data</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card__body">
                            <h3>Data Management</h3>
                            <div class="data-management">
                                <p>Manage your expense data and preferences.</p>
                                <div class="settings-actions">
                                    <button class="btn btn--secondary" onclick="app.importData()">Import Data</button>
                                    <button class="btn btn--outline" onclick="app.clearAllData()">Clear All Data</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card__body">
                            <h3>Setup Instructions</h3>
                            <div class="setup-instructions">
                                <h4>Google Drive Integration Setup:</h4>
                                <ol style="font-size: var(--font-size-sm); margin: var(--space-12) 0;">
                                    <li>Go to <a href="https://console.developers.google.com/" target="_blank">Google Cloud Console</a></li>
                                    <li>Navigate to <strong>APIs & Services</strong> ‚Üí <strong>Credentials</strong></li>
                                    <li>Click on your OAuth 2.0 Client ID</li>
                                    <li>Add your Vercel domain to <strong>Authorized JavaScript origins</strong></li>
                                    <li>Save and wait a few minutes for changes to take effect</li>
                                </ol>
                                <p style="font-size: var(--font-size-xs); color: var(--color-text-secondary);">
                                    <strong>Current Client ID:</strong><br>
                                    233167876623-d6qu3irgp5k90em45klitumise38c329.apps.googleusercontent.com
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Sync Settings Modal -->
        <div id="sync-settings-modal" class="modal hidden">
            <div class="modal__overlay" onclick="app.hideSyncSettings()"></div>
            <div class="modal__content">
                <h3>Sync Settings</h3>
                <div class="sync-settings-content">
                    <div class="sync-status-info">
                        <h4>Current Status</h4>
                        <div class="status-row">
                            <span>Connection:</span>
                            <span id="connection-status">Local Storage Only</span>
                        </div>
                        <div class="status-row">
                            <span>Last Sync:</span>
                            <span id="last-sync">Never</span>
                        </div>
                        <div class="status-row">
                            <span>Data Records:</span>
                            <span id="data-count">0 expenses, 0 methods, 0 reminders</span>
                        </div>
                        <div class="status-row">
                            <span>Drive Folder:</span>
                            <span id="drive-folder">ExpenseTracker</span>
                        </div>
                        <div class="status-row">
                            <span>Client ID:</span>
                            <span style="font-size: var(--font-size-xs); word-break: break-all;">233167876623-d6qu3irgp5k90em45klitumise38c329.apps.googleusercontent.com</span>
                        </div>
                    </div>
                    
                    <div class="sync-actions">
                        <button class="btn btn--primary" onclick="app.manualSync()" disabled>Manual Sync</button>
                        <button class="btn btn--secondary" onclick="app.connectGoogleDrive()">Setup Google Drive</button>
                        <button class="btn btn--outline" onclick="app.hideSyncSettings()">Close</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>